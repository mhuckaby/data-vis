<!DOCTYPE html>
<html>
  <head>
    <title>Chart Demo</title>
    <script src="javascripts/echarts.min.js"></script>
    <script src="javascripts/chart-new-bbs-starts-by-year-by-state.data.js"></script>
  </head>
  <body>
    <div id="main" style="width:100%; height:700px; padding-top:5em;"></div>
  </body>

  <script type="text/javascript">
    const myChart = echarts.init(document.getElementById('main'));
    const bbsTotalsPerYearPerState = window.global_temp.bbs;

    // Filter duplicates -> distinct array
    const filterDuplicates = (e, position, arr) => {
      return arr.indexOf(e) == position;
    };

    // List of all the states - distinct
    const stateCodes = bbsTotalsPerYearPerState.map(f => {
      return f.state_code;
    }).filter(filterDuplicates);

    // List of all the years - distinct
    const xAxisData = bbsTotalsPerYearPerState.map(f => {
      return f.start;
    }).filter(filterDuplicates).reverse();

    // Object format supported by graph lib
    const graphObject = (stateCode, countPerYear) => {
      return { "name": stateCode, "type": "line", "stack": "ByYearByState", "areaStyle": {}, "data": countPerYear }
    };

    // For each stateCode, generate an array (size xAxisData.length) of counts per year
    const fitToGraph = stateCodes.map(stateCode => {
      const recordsByState = bbsTotalsPerYearPerState.filter(f => f.state_code === stateCode);
      const countPerYear = xAxisData.map(year => {
        const match = recordsByState.filter(record => record.start === year);
        return match && match.length > 0 ? match[0].count : 0;
      });

      return graphObject(stateCode, countPerYear);
    });

    option = {
      title: {
        text: 'Total BBS Starts Recorded by Year by State'
      },
      tooltip : {
        trigger: 'axis',
        axisPointer: {
          type: 'cross',
          label: {
            backgroundColor: '#6a7985'
          }
        }
      },
      legend: {
        data:['Total BBS Recorded by Year']
      },
      toolbox: {
        feature: {
          saveAsImage: {
            title: 'Save'
          }
        }
      },
      grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
      },
      xAxis : [
        {
          type : 'category',
          boundaryGap : false,
          data : xAxisData
        }
      ],
      yAxis : [
        {
          type : 'value'
        }
      ],
      series : fitToGraph
    };

    myChart.setOption(option);
  </script>
</html>
